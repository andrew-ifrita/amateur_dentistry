# Deploy to Bulletin Chain and register a DotNS domain using the reusable
# workflow from paritytech/dotns-sdk.
#
# Pushes to master deploy to the base domain (andrewexample00.dot).
# Pull requests get a preview subname (e.g. pr42.andrewexample00.dot).
name: Deploy

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    name: Build Site
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare site artifact
        run: |
          mkdir -p site
          cp index.html *.jpg *.jpeg *.png *.avif *.webp site/ 2>/dev/null || true

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: site/
          retention-days: 7

  deploy:
    name: Deploy
    needs: [build]
    uses: paritytech/dotns-sdk/.github/workflows/deploy.yml@main
    with:
      basename: andrewexample00
      artifact-name: site
      mode: ${{ github.event_name == 'push' && 'production' || 'preview' }}
      register-base: true
    secrets:
      mnemonic: ${{ secrets.DOTNS_MNEMONIC }}

  comment:
    name: Comment on PR
    needs: [deploy]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Post deployment URL
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: deploy-preview
          message: |
            ### Deployed
            **URL:** https://${{ needs.deploy.outputs.fqdn && needs.deploy.outputs.url || 'andrewexample00.paseo.li' }}
            **Domain:** `${{ needs.deploy.outputs.fqdn }}`
            **CID:** `${{ needs.deploy.outputs.cid }}`
